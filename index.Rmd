---
title: "Status Coronavirus di Indonesia"
author: "Aldilas Achmad N."
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    # social: ["facebook", "twitter", "linkedin"]
    source_code: embed
    vertical_layout: fill
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
#------------------ Packages ------------------
library(flexdashboard)
library(dplyr)
library(plotly)
library(googlesheets4)
library(gargle)
library(curl)
library(networkD3)
library(igraph)
library(htmlwidgets)
library(htmltools)
library(readxl)
#------------------ Parameters ------------------
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color
confirmed_color <- "purple"
active_color <- "#1f77b4"
recovered_color <- "forestgreen"
death_color <- "red"
numtest_color <- "orange"
#------------------ Data Indonesia---------------
# designate project-specific cache
#options(gargle_oauth_cache = ".kawalcovidauth", gargle_oauth_email = "mail.aldilas@gmail.com")
sheets_auth(cache = ".kawalcovidauth")
df <- read_sheet("1ma1T9hWbec1pXlwZ89WakRk-OfVUQZsOCFl4FwZxzVw", sheet = "Statistik Harian") %>% rename(X1 = 1, recovered_daily = 7, recovered_cum = 8, death_cum = 10, death_daily = 9)
df$X1 <- as.Date(df$X1, format = "%d %b")
#------------------ Data lokal pulau Jawa--------
provCaseCum <- read_sheet("1ma1T9hWbec1pXlwZ89WakRk-OfVUQZsOCFl4FwZxzVw", sheet = "Timeline", range = cell_rows(1:23)) %>% rename(date = 1)
#provRecoverCum <- read_sheet("1ma1T9hWbec1pXlwZ89WakRk-OfVUQZsOCFl4FwZxzVw", sheet = "Timeline", range = cell_rows(50:68)) %>% rename(date = 1)
#provDeathCum<- read_sheet("1ma1T9hWbec1pXlwZ89WakRk-OfVUQZsOCFl4FwZxzVw", sheet = "Timeline", range = cell_rows(90:111)) %>% rename(date = 1)
```

Statistik Nasional
=======================================================================

Row {data-width=400}
-----------------------------------------------------------------------

### confirmed {.value-box}

```{r}
valueBox(
  value = paste(format(sum(df$`Kasus baru`, na.rm = T), big.mark = ","), "", sep = " "),
  caption = "Total kasus terkonfirmasi",
  icon = "fas fa-user-md",
  color = active_color
)
```

### Recovered {.value-box}
```{r}
valueBox(
  value = paste(format(sum(df$recovered_daily, na.rm=TRUE), big.mark = ","), " (", round(100 *  sum(df$recovered_daily, na.rm = TRUE) / sum(df$`Kasus baru`, na.rm=TRUE), 1), "%)", sep = ""),
  caption = "Jumlah kasus sembuh",
  icon = "fas fa-laugh",
  color = recovered_color)
```

### death {.value-box}

```{r}

valueBox(
  value = paste(format(sum(df$death_daily, na.rm = TRUE), big.mark = ","), " (", round(100 * sum(df$death_daily, na.rm = TRUE) / sum(df$`Kasus baru`, na.rm = TRUE), 1), "%)", sep = ""),
  caption = "Jumlah kasus meninggal",
  icon = "fas fa-sad-tear",
  color = death_color
)
```

### Num of Test {.value-box}

```{r}

valueBox(
  value = paste(format(sum(df$`Tes Harian`, na.rm = TRUE), big.mark = ","), "", sep = " "),
  caption = "Jumlah tes yang telah dilakukan",
  icon = "fas fa-vial",
  color = numtest_color
)
```

Row {data-width=400}
-----------------------------------------------------------------------

### **Laporan kasus kumulatif**
    
```{r message=FALSE, warning=FALSE}
plot_ly(data = df) %>%
  add_trace(
    x = ~X1,
    # y = ~active_cum,
    y = ~`Jumlah kasus`,
    type = "scatter",
    mode = "lines+markers",
    # name = "Active",
    name = "Jumlah kasus Terkonfirmasi",
    line = list(color = active_color),
    marker = list(color = active_color)
  ) %>%
  add_trace(
    x = ~X1,
    y = ~death_cum,
    type = "scatter",
    mode = "lines+markers",
    name = "Jumlah kasus kematian",
    line = list(color = death_color),
    marker = list(color = death_color)
  ) %>%
  add_trace(
    x = ~X1,
    y = ~recovered_cum,
    type = "scatter",
    mode = "lines+markers",
    name = "Jumlah kasus sembuh",
    line = list(color = recovered_color),
    marker = list(color = recovered_color)
  ) %>%
  add_annotations(
    x = as.Date("2020-03-11"),
    y = 3,
    text = paste("Kematian pertama"),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -90,
    ay = -90
  ) %>%
  layout(
    title = "",
    yaxis = list(title = "Jumlah kasus kumulatif"),
    xaxis = list(title = "Tanggal"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare"
  )
```

### **Laporan kasus harian**
```{r message=FALSE, warning=FALSE}
plot_ly(data = df) %>% 
  add_trace(
    x = ~X1,
    y = ~`Kasus baru`,
    name = "Kasus terkonfirmasi baru",
    type = "bar",
    mode = "lines+markers",
    marker = list(color = active_color),
    line = list(color = active_color)
  ) %>% 
  add_trace(
    x = ~X1,
    y = ~death_daily,
    name = "Kasus meninggal",
    type = "bar",
    mode = "lines+markers",
    marker = list(color = death_color),
    line = list(color = death_color)
  ) %>%
  add_trace(
    x = ~X1,
    y = ~recovered_daily,
    name = "Kasus sembuh",
    type = "bar",
    mode = "lines+markers",
    marker = list(color = recovered_color),
    line = list(color = recovered_color)
  ) %>%
  add_trace(
    x = ~X1,
    y = ~`Tes Harian`,
    name = "Jumlah test yang dilakukan",
    type = "bar",
    mode = "lines+markers",
    marker = list(color = numtest_color),
    line = list(color = numtest_color)
  ) %>% 
  add_annotations(
    x = as.Date("2020-03-16"),
    y = 3,
    text = paste("Perubahan kriteria pemeriksaan"),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -90,
    ay = -90
  ) %>% 
  layout(
    title = "",
    yaxis = list(title = "Jumlah kasus harian"),
    xaxis = list(title = "Tanggal"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare"
  )
```


Statistik Provinsi
=======================================================================

Row {data-width=400}
-----------------------------------------------------------------------
### Perbandingan data kumulatif antar-provinsi di Pulau Jawa
```{r}
plot_ly(data = provCaseCum) %>% 
  add_trace(
    x = ~date,
    y = ~Jakarta,
    name = "DKI Jakarta",
    type = "scatter",
    mode = "lines+markers"
  ) %>% 
  add_trace(
    x = ~date,
    y = ~Banten,
    name = "Banten",
    type = "scatter",
    mode = "lines+markers"
  ) %>% 
  add_trace(
    x = ~date,
    y = ~Jabar,
    name = "Jawa Barat",
    type = "scatter",
    mode = "lines+markers"
  ) %>% 
  add_trace(
    x = ~date,
    y = ~Jateng,
    name = "Jawa Tengah",
    type = "scatter",
    mode = "lines+markers"
  ) %>% 
  add_trace(
    x = ~date,
    y = ~DIY,
    name = "DI Yogyakarta",
    type = "scatter",
    mode = "lines+markers"
  ) %>% 
  add_trace(
    x = ~date,
    y = ~Jatim,
    name = "Jawa Timur",
    type = "scatter",
    mode = "lines+markers"
  ) %>% 
  layout(
    title = "",
    yaxis = list(title = "Jumlah Kasus Kumulatif"),
    xaxis = list(title = "Tanggal"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare"
  )
```

Kluster Map
=======================================================================

Row {data-width=400}
-------------------------------------

### Visualisasi Cluster Infeksi

```{r}
idn.covidtracing <- read.csv("https://docs.google.com/spreadsheets/d/1ma1T9hWbec1pXlwZ89WakRk-OfVUQZsOCFl4FwZxzVw/export?format=csv&gid=0", sep=",", skip = 1)
idn.covidtracing$Sumber.Kontak <- ifelse(idn.covidtracing$Jenis.kasus == "Impor", "Impor", as.character(idn.covidtracing$Sumber.Kontak))
tracing.network <- idn.covidtracing %>% select(No, Sumber.Kontak)
tracing.network$Sumber.Kontak <- ifelse(tracing.network$Sumber.Kontak == "", tracing.network$No, as.character(tracing.network$Sumber.Kontak))

simpleNetwork(tracing.network, fontSize = 12, zoom = TRUE)
```

World Map
=======================================================================

### **Jumlah kasus di seluruh dunia**

```{r message=FALSE, warning=FALSE}
# map tab added by Art Steinmetz
library(leaflet)
library(leafpop)
library(purrr)
library(coronavirus)
cv_data_for_plot <- coronavirus %>%
  # dplyr::filter(Country.Region == "Belgium") %>%
  dplyr::filter(cases > 0) %>%
  dplyr::group_by(Country.Region, Province.State, Lat, Long, type) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::mutate(log_cases = 2 * log(cases)) %>%
  dplyr::ungroup()
cv_data_for_plot.split <- cv_data_for_plot %>% split(cv_data_for_plot$type)
pal <- colorFactor(c("orange", "red", "green"), domain = c("Terkonfirmasi", "Kematian", "Sembuh"))
map_object <- leaflet() %>% addProviderTiles(providers$Stamen.Toner)
names(cv_data_for_plot.split) %>%
  purrr::walk(function(df) {
    map_object <<- map_object %>%
      addCircleMarkers(
        data = cv_data_for_plot.split[[df]],
        lng = ~Long, lat = ~Lat,
        #                 label=~as.character(cases),
        color = ~ pal(type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases,
        popup = leafpop::popupTable(cv_data_for_plot.split[[df]],
          feature.id = FALSE,
          row.numbers = FALSE,
          zcol = c("type", "cases", "Country.Region", "Province.State")
        ),
        group = df,
        #                 clusterOptions = markerClusterOptions(removeOutsideVisibleBounds = F),
        labelOptions = labelOptions(
          noHide = F,
          direction = "auto"
        )
      )
  })

map_object %>%
  addLayersControl(
    overlayGroups = names(cv_data_for_plot.split),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Tentang Dasbor
=======================================================================

**Dasbor Situasi Coronavirus di Indonesia**

Dasbor ini merupakan visualisasi data mengenai epidemi COVID-19 yang sedang berlangsung di Indonesia. Dasbor ini dikembangkan menggunakan piranti lunak R. Pengembangan dasbor ini diadaptasi dari [dasbor](https://ramikrispin.github.io/coronavirus_dashboard/){target="_blank"} yang dikembangkan oleh Rami Krispin.

**Data**

Data yang digunakan untuk pengembangan dasbor ini menggunakan data yang dikumpulkan oleh relawan [KawalCovID19](https://kawalcovid19.id){target="_blank"} dan juga dataset dari pustaka R [`{coronavirus}`](https://github.com/RamiKrispin/coronavirus){target="_blank"} 

Data akan selalu diupdate setiap hari.

Data mentah diambil dari data yang disediakan Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) Coronavirus [repositori](https://github.com/RamiKrispin/coronavirus-csv){target="_blank"}.

**Kontak**

Untuk mengetahui kode sumber dasbor ini dapat mengunjungi [Github](https://github.com/aldeetropolis/flexboard-covid-id){target="_blank"}.
